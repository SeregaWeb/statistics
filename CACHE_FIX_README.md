# Исправление проблемы с кешированием водителей

## Проблема
В системе TMS наблюдалась проблема, когда статус водителей отображался некорректно - показывались водители со статусом "on_hold", которые уже были удалены из базы данных. Это происходило из-за неправильного управления кешем.

## Причина
В методе `update_driver_status_in_db()` отсутствовал вызов `clear_drivers_cache()`, что приводило к тому, что при обновлении статуса водителя кеш не очищался, и старые данные оставались в кеше.

## Исправления

### 1. Обновлен метод `update_driver_status_in_db()`
**Файл:** `wp-content/themes/wp-rock/src/inc/core/class-tms-drivers.php`

Добавлен вызов `clear_drivers_cache()` в конце метода для очистки кеша при обновлении статуса водителя.

```php
// Clear drivers cache when driver status is updated
$this->clear_drivers_cache();
```

### 2. Обновлен метод `hold_driver_status()`
**Файл:** `wp-content/themes/wp-rock/src/inc/core/class-tms-drivers.php`

Исправлена логика удержания водителей:
- Добавлена проверка на продление времени удержания для водителей, уже находящихся на удержании
- Исправлена проблема с сохранением статуса `on_hold` в таблице холда
- Добавлена защита от восстановления некорректного статуса при освобождении
- Добавлены вызовы `clear_drivers_cache()` при удержании и освобождении водителя

### 3. Добавлен метод `extend_driver_hold_time()`
**Файл:** `wp-content/themes/wp-rock/src/inc/core/class-tms-drivers.php`

Новый метод для продления времени удержания водителя без изменения его статуса.

### 4. Улучшен метод `cron_delete_expired_holds()`
**Файл:** `wp-content/themes/wp-rock/src/inc/core/class-tms-drivers.php`

Добавлена защита от восстановления некорректного статуса `on_hold` при автоматической очистке истекших удержаний.

### 3. Обновлен метод `cron_delete_expired_holds()`
**Файл:** `wp-content/themes/wp-rock/src/inc/core/class-tms-drivers.php`

Добавлена очистка кеша при автоматическом восстановлении статусов водителей через cron.

### 4. Улучшен метод `clear_drivers_cache()`
**Файл:** `wp-content/themes/wp-rock/src/inc/core/class-tms-drivers.php`

Метод теперь очищает не только основной кеш, но и все связанные с водителями кеши:

```php
/**
 * Clear all drivers related cache
 * 
 * @return bool Success status
 */
public function clear_drivers_cache() {
    global $wpdb;
    
    // Clear the main drivers cache
    $result1 = delete_transient( 'tms_all_available_drivers' );
    
    // Clear any other drivers related transients that might exist
    $prefix = 'tms_drivers_';
    $sql = $wpdb->prepare( "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s", $wpdb->esc_like( '_transient_' . $prefix ) . '%' );
    $result2 = $wpdb->query( $sql );
    
    // Also delete the timeout entries
    $sql2 = $wpdb->prepare( "DELETE FROM {$wpdb->options} WHERE option_name LIKE %s", $wpdb->esc_like( '_transient_timeout_' . $prefix ) . '%' );
    $result3 = $wpdb->query( $sql2 );
    
    return ( $result1 !== false && $result2 !== false && $result3 !== false );
}
```

## Новые функции

### 1. Административная страница управления кешем
**Файл:** `wp-content/themes/wp-rock/src/inc/admin-cache-manager.php`

Создана административная страница "Drivers Cache" в разделе "Инструменты" для:
- Просмотра статуса кеша
- Очистки кеша водителей
- Обновления кеша с свежими данными
- Очистки кеша координат
- Просмотра статистики водителей
- **Исправления проблемных записей удержания** (новая функция)

### 2. Функция исправления проблемных записей
**Файл:** `wp-content/themes/wp-rock/src/inc/admin-cache-manager.php`

Добавлена функция `fix_hold_status_issues()` которая:
- Исправляет водителей со статусом `on_hold`, но без записи в таблице холда
- Исправляет записи в таблице холда со статусом `on_hold`
- Очищает истекшие удержания, которые не были автоматически удалены
- Автоматически очищает кеш после исправлений

## Как использовать

### Автоматическая очистка кеша
Теперь кеш автоматически очищается при:
- Обновлении статуса водителя
- Удержании/освобождении водителя
- Автоматическом восстановлении статусов через cron

### Ручная очистка кеша
1. Перейдите в админ-панель WordPress
2. Выберите "Инструменты" → "Drivers Cache"
3. Используйте кнопки для управления кешем:
   - **Clear Drivers Cache** - очищает кеш водителей
   - **Refresh Drivers Cache** - очищает и обновляет кеш
   - **Clear All Cache** - очищает все кеши
   - **Fix Hold Status Issues** - исправляет проблемные записи удержания (красная кнопка)

### Исправление проблемных записей
Если у вас есть водители со статусом `on_hold`, но пустая таблица холда:
1. Перейдите в "Инструменты" → "Drivers Cache"
2. Нажмите кнопку **"Fix Hold Status Issues"**
3. Система автоматически исправит все проблемные записи

### Продление удержания
Теперь при повторном удержании водителя тем же диспетчером:
- Время удержания продлевается
- Статус водителя не меняется (остается `on_hold`)
- В таблицу холда не попадает некорректный статус

## Проверка исправления

После внедрения исправлений:

1. **Исправьте существующие проблемы:**
   - Перейдите в "Инструменты" → "Drivers Cache"
   - Нажмите кнопку **"Fix Hold Status Issues"**
   - Проверьте, что водители со статусом `on_hold` исправлены

2. **Проверьте, что кеш очищается автоматически:**
   - Измените статус водителя
   - Проверьте, что новые данные отображаются сразу

3. **Проверьте продление удержания:**
   - Удержите водителя
   - Попробуйте удержать его снова тем же диспетчером
   - Убедитесь, что время продлевается, а статус не меняется

4. **Проверьте административную страницу:**
   - Перейдите в "Инструменты" → "Drivers Cache"
   - Убедитесь, что страница загружается корректно
   - Протестируйте функции очистки кеша

5. **Проверьте, что старые данные больше не отображаются:**
   - Удалите водителя из базы данных
   - Убедитесь, что он больше не появляется в списках

## Дополнительные рекомендации

1. **Мониторинг кеша:** Регулярно проверяйте административную страницу кеша для мониторинга его состояния.

2. **Логирование:** При необходимости можно добавить логирование операций с кешем для отладки.

3. **Оптимизация:** Рассмотрите возможность увеличения времени жизни кеша, если производительность позволяет.

## Файлы, которые были изменены

1. `wp-content/themes/wp-rock/src/inc/core/class-tms-drivers.php` - основные исправления
2. `wp-content/themes/wp-rock/src/inc/admin-cache-manager.php` - новая административная страница
3. `wp-content/themes/wp-rock/functions.php` - подключение нового файла
4. `wp-content/themes/wp-rock/test-cache-clear.php` - тестовый файл
5. `wp-content/themes/wp-rock/CACHE_FIX_README.md` - данная документация 